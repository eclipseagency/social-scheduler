// Prisma schema for Social Media Management Platform
// Production-ready, scalable architecture

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

// ==================== USER & AUTHENTICATION ====================

// User model with role-based access control
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  role          Role      @default(MODERATOR)
  avatar        String?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  clients       Client[]  @relation("UserClients")
  posts         Post[]    @relation("PostCreator")
  sessions      Session[]
}

// Session for authentication
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Role enum (stored as string in SQLite)
enum Role {
  ADMIN
  MODERATOR
}

// ==================== CLIENT MANAGEMENT ====================

// Client - companies/brands managed by the platform
model Client {
  id            String      @id @default(uuid())
  name          String
  email         String?
  phone         String?
  company       String?
  logoUrl       String?
  description   String?
  brandTone     BrandTone   @default(PROFESSIONAL)
  industry      String?
  website       String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // User who manages this client
  userId        String
  user          User        @relation("UserClients", fields: [userId], references: [id], onDelete: Cascade)

  // Relationships
  socialAccounts SocialAccount[]
  posts          Post[]
  mediaAssets    MediaAsset[]
  captionHistory CaptionHistory[]
}

// Brand tone for AI caption generation
enum BrandTone {
  PROFESSIONAL
  FRIENDLY
  CASUAL
  FORMAL
  HUMOROUS
  INSPIRATIONAL
  SALES_DRIVEN
  EDUCATIONAL
}

// ==================== SOCIAL MEDIA PLATFORMS ====================

// Predefined social platforms
model SocialPlatform {
  id            String    @id @default(uuid())
  name          String    @unique // Instagram, Facebook, LinkedIn
  icon          String?
  color         String?   // Brand color for UI
  maxCaptionLength Int?   // Platform-specific limits
  supportsVideo Boolean   @default(true)
  supportsCarousel Boolean @default(false)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  socialAccounts SocialAccount[]
  platformSchedules PlatformSchedule[]
}

// Social account connection between Client and Platform
model SocialAccount {
  id            String    @id @default(uuid())
  accountName   String
  accountId     String?   // Platform-specific account ID
  username      String?
  profileUrl    String?
  accessToken   String?   // OAuth access token (encrypted in production)
  refreshToken  String?   // OAuth refresh token
  tokenExpiry   DateTime?
  isConnected   Boolean   @default(false)
  followerCount Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  platformId    String
  platform      SocialPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  platformSchedules PlatformSchedule[]
}

// ==================== POST MANAGEMENT ====================

// Main Post model
model Post {
  id              String      @id @default(uuid())
  title           String?
  caption         String?
  hashtags        String?     // Comma-separated hashtags
  mediaType       MediaType   @default(IMAGE)
  status          PostStatus  @default(DRAFT)
  errorMessage    String?

  // AI-related fields
  aiGenerated     Boolean     @default(false)
  aiPromptUsed    String?

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relationships
  clientId        String
  client          Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdById     String
  createdBy       User        @relation("PostCreator", fields: [createdById], references: [id])

  // Multiple platform schedules for different posting times
  platformSchedules PlatformSchedule[]

  // Media assets attached to this post
  mediaAssets     PostMediaAsset[]
}

// Platform-specific scheduling
model PlatformSchedule {
  id              String      @id @default(uuid())
  scheduledAt     DateTime
  publishedAt     DateTime?
  status          PostStatus  @default(SCHEDULED)
  errorMessage    String?
  platformPostId  String?     // ID from the platform after posting

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relationships
  postId          String
  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)

  socialAccountId String
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  platformId      String
  platform        SocialPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
}

// Post status enum
enum PostStatus {
  DRAFT
  SCHEDULED
  POSTED
  FAILED
}

// Media type enum
enum MediaType {
  IMAGE
  VIDEO
  CAROUSEL
}

// ==================== MEDIA MANAGEMENT ====================

// Media assets uploaded to the platform
model MediaAsset {
  id            String    @id @default(uuid())
  fileName      String
  originalName  String
  filePath      String
  fileUrl       String
  fileType      String    // image, video
  mimeType      String
  fileSize      Int       // in bytes
  width         Int?
  height        Int?
  duration      Int?      // for videos, in seconds
  thumbnail     String?   // thumbnail URL for videos

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Posts using this media
  posts         PostMediaAsset[]
}

// Junction table for Post and MediaAsset (many-to-many)
model PostMediaAsset {
  id            String    @id @default(uuid())
  order         Int       @default(0)  // For carousel ordering

  postId        String
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  mediaAssetId  String
  mediaAsset    MediaAsset @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)

  @@unique([postId, mediaAssetId])
}

// ==================== AI CAPTION HISTORY ====================

// Track caption history to avoid repetition
model CaptionHistory {
  id            String    @id @default(uuid())
  caption       String
  hashtags      String?
  platform      String    // Which platform this was for
  keywords      String?   // Keywords extracted from the caption
  usedAt        DateTime  @default(now())

  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// ==================== SYSTEM ====================

// Contact messages from website
model ContactMessage {
  id            String    @id @default(uuid())
  name          String
  email         String
  message       String
  status        String    @default("unread") // unread, read, replied
  createdAt     DateTime  @default(now())
}
