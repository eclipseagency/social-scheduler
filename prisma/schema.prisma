// Prisma schema for Social Media Scheduler Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// Admin user who manages everything
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  role          String    @default("admin") // admin or client
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clients       Client[]  @relation("AdminClients")
  clientAccess  Client?   @relation("ClientUser")
}

// Clients managed by the admin
model Client {
  id            String          @id @default(uuid())
  name          String
  email         String?
  phone         String?
  company       String?
  logoUrl       String?         // Logo image URL for easy recognition
  description   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Admin who manages this client
  adminId       String
  admin         User            @relation("AdminClients", fields: [adminId], references: [id], onDelete: Cascade)

  // Client user account (for client dashboard access)
  userId        String?         @unique
  user          User?           @relation("ClientUser", fields: [userId], references: [id])

  // Social media accounts
  socialAccounts SocialAccount[]

  // Scheduled posts
  posts         Post[]

  // Caption history for AI to avoid repetition
  captionHistory CaptionHistory[]
}

// Social media accounts for each client
model SocialAccount {
  id            String    @id @default(uuid())
  platform      String    // instagram, facebook, linkedin
  accountName   String
  accountId     String?   // Platform-specific account ID
  accessToken   String?   // OAuth access token
  refreshToken  String?   // OAuth refresh token
  tokenExpiry   DateTime?
  isConnected   Boolean   @default(false)
  profileUrl    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  posts         Post[]
}

// Scheduled posts
model Post {
  id              String    @id @default(uuid())
  title           String?
  caption         String?
  imageUrl        String?   // Uploaded design image
  mediaType       String    @default("image") // image, video, carousel
  postType        String    @default("image_first") // image_first, text_first
  status          String    @default("draft") // draft, scheduled, published, failed
  scheduledAt     DateTime?
  publishedAt     DateTime?
  errorMessage    String?

  // AI-generated caption metadata
  aiGenerated     Boolean   @default(false)
  aiPromptUsed    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  clientId        String
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  socialAccountId String
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
}

// Track caption history to avoid repetition
model CaptionHistory {
  id            String    @id @default(uuid())
  caption       String
  keywords      String?   // Keywords extracted from the caption
  usedAt        DateTime  @default(now())

  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// Contact messages from chatbot
model ContactMessage {
  id            String    @id @default(uuid())
  name          String
  email         String
  message       String
  status        String    @default("unread") // unread, read, replied
  createdAt     DateTime  @default(now())
}

// Store uploaded media files
model MediaFile {
  id            String    @id @default(uuid())
  fileName      String
  filePath      String
  fileType      String    // image, video
  fileSize      Int
  mimeType      String
  uploadedAt    DateTime  @default(now())
}
